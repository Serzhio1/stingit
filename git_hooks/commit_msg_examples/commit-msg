#!/bin/bash
# ============================================================
#                   Git Commit Message Hook
# ------------------------------------------------------------
# Скрипт для проверки формата сообщения коммита
#
# Требования к сообщению коммита:
#  1. В начале обязательно один из типов:
#       fix:, refactor:, test:
#  2. Далее через пробел ссылка на задачу в JIRA в формате:
#       [OSG-123], [OSG-12], [OSG-1234] и т.п.
#  3. После этого через пробел должно идти содержательное сообщение,
#       не являющееся слишком общим/мусорным (например, "fix bug", "do smth" и т.п.)
#
# Примеры правильных сообщений:
#  - fix: [OSG-123] исправлен баг с авторизацией
#  - docs: [OSG-12] обновлена документация по API
#  - refactor: [OSG-134] переработан модуль логирования
#  - test: [OSG-56] добавлены тесты для нового функционала
#
# Примеры сообщений, которые вызовут ошибку:
#  - fix bug
#  - do smth
#  - test: [OSG-123] 
#  - update [OSG-12] minor changes
#
# Важно:
#  - Этот скрипт выполняется на этапе "commit", после того как сообщение коммита сформировано
#  - Скрипт должен называться ровно: "commit-msg", и никак иначе
#  - Скрипт должен находиться в каталоге: ".git/hooks/", и нигде иначе 
#  - Файл должен быть исполняемым (chmod +x)
#
# ============================================================


# Переменные, в которых не стоит менять значения
MSG_FILE=$1
ROW_COMMIT_MSG=$(cat "$MSG_FILE")
COMMIT_MSG=$(echo "$ROW_COMMIT_MSG" | tr -d '\r')  # CRLF -> LF

# Переменные, в которых без проблем можно поменять значения на свой взгляд
ALLOWED_COMMIT_TYPES="fix:|refactor:|test:"
PREFIX_TASK_NAME="OSG"
EXAMPLE_GOOD_COMMIT_MESSAGE="Пример хорошего коммита «fix: [${PREFIX_TASK_NAME}-1194] для 1С реализовал метод 'calculateDevSalary()', который увеличивает зарплату программистам вдвое»"
BAD_BODY_COMMIT_MESSAGES=("fix bug" "do smth" "test" "update" "temp" "misc" "minor changes" "bugfix" "wip")


# ---------- 1. Проверка типа коммита ----------
if ! [[ "${COMMIT_MSG}" =~ ^(${ALLOWED_COMMIT_TYPES}) ]]; then
    echo "Ошибка: сообщение коммита должно начинаться с одного из следующих префиксов: ${ALLOWED_COMMIT_TYPES}"
    echo "${EXAMPLE_GOOD_COMMIT_MESSAGE}"
    exit 1
fi

# ---------- 2. Проверка на наличие единственного двоеточия после типа коммита ----------
if [[ "${COMMIT_MSG}" =~ ^(${ALLOWED_COMMIT_TYPES}):{2,} ]]; then
    echo "Ошибка: после типа коммита должно находиться только одно двоеточие"
    echo "${EXAMPLE_GOOD_COMMIT_MESSAGE}"
    exit 1
fi

# ---------- 3. Проверка на отсутствие задачи и описания изменений ----------
if [[ "${COMMIT_MSG}" =~ ^(${ALLOWED_COMMIT_TYPES})[[:space:]]*$ ]]; then
    echo "Ошибка: помимо префикса, в сообщении коммита обязательно должны присутствовать задача и описание изменений"
    echo "${EXAMPLE_GOOD_COMMIT_MESSAGE}"
    exit 1
fi

# ---------- 4. Проверка отсутствие пробела после двоеточия ----------
if ! [[ "${COMMIT_MSG}" =~ ^(${ALLOWED_COMMIT_TYPES})[[:space:]] ]]; then
    echo "Ошибка: перед задачей должен находиться один пробел и никаких лишних символов"
    echo "${EXAMPLE_GOOD_COMMIT_MESSAGE}"
    exit 1
fi
# ---------- 4.1. Проверка на наличие единственного пробела после двоеточия ----------
if [[ "${COMMIT_MSG}" =~ ^(${ALLOWED_COMMIT_TYPES})[[:space:]]{2,} ]]; then
    echo "Ошибка: перед задачей должен находиться только один пробел"
    echo "${EXAMPLE_GOOD_COMMIT_MESSAGE}"
    exit 1
fi

# ---------- 5. Проверка на наличие задачи ----------
if ! [[ "${COMMIT_MSG}" =~ ^(${ALLOWED_COMMIT_TYPES})[[:space:]]\[${PREFIX_TASK_NAME}-[0-9]+\] ]]; then
    echo "Ошибка: после типа коммита ожидается задача в формате [${PREFIX_TASK_NAME}-123]"
    echo "${EXAMPLE_GOOD_COMMIT_MESSAGE}"
    exit 1
fi

#----------- 6. Проверка на отсутствие описания изменений ---------- 
if [[ "${COMMIT_MSG}" =~ ^(${ALLOWED_COMMIT_TYPES})[[:space:]]\[${PREFIX_TASK_NAME}-[0-9]+\][[:space:]]*$ ]]; then
    echo "Ошибка: помимо префикса и задачи, в сообщении коммита обязательно должно присутствовать описание изменений"
    echo "${EXAMPLE_GOOD_COMMIT_MESSAGE}"
    exit 1
fi

# ---------- 7. Проверка отсутствие пробела после задачи ----------
if ! [[ "${COMMIT_MSG}" =~ ^(${ALLOWED_COMMIT_TYPES})[[:space:]]\[${PREFIX_TASK_NAME}-[0-9]+\][[:space:]] ]]; then
    echo "Ошибка: после задачи должен находится один пробел и никаких лишних символов"
    echo "${EXAMPLE_GOOD_COMMIT_MESSAGE}"
    exit 1
fi
# ---------- 7.1 Проверка на наличие единственного пробела после задачи ----------
if [[ "${COMMIT_MSG}" =~ ^(${ALLOWED_COMMIT_TYPES})[[:space:]]\[${PREFIX_TASK_NAME}-[0-9]+\][[:space:]]{2,} ]]; then
    echo "Ошибка: после задачи должен находится только один пробел"
    echo "${EXAMPLE_GOOD_COMMIT_MESSAGE}"
    exit 1
fi

# ---------- 8. Проверка на то, что тело сообщения - не пустое ----------
NOT_TRIM_MESSAGE_BODY=$(echo "${COMMIT_MSG}" | sed -E "s/^(${ALLOWED_COMMIT_TYPES})[[:space:]]\[${PREFIX_TASK_NAME}-[0-9]+\]//")
MESSAGE_BODY="$(echo -e "${NOT_TRIM_MESSAGE_BODY}" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')"
if [[ -z "${MESSAGE_BODY}" ]]; then
    echo "Ошибка: тело сообщения коммита - пустое. Добавьте описание коммита"
    echo "${EXAMPLE_GOOD_COMMIT_MESSAGE}"
    exit 1
fi

# ---------- 9. Проверка на наличие "мусорных фраз" в теле сообщения коммита ----------
LOWERCASE_MESSAGE_BODY="${MESSAGE_BODY,,}"
for bad_message in "${BAD_BODY_COMMIT_MESSAGES[@]}"; do
    if [[ "${LOWERCASE_MESSAGE_BODY}" == "$bad_message" ]]; then
        echo "Ошибка: тело сообщения содержит слишком общую / неинформативную фразу: \"$MESSAGE_BODY\""
        echo "Пожалуйста, опиши более конкретно свои изменения"
        exit 1
    fi
done

# ---------- 10. Проверка на длину тела сообщения коммита ----------
LEN_MESSAGE_BODY=${#MESSAGE_BODY}
if (( LEN_MESSAGE_BODY > 100 )); then
    echo "Ошибка: текущая длина тела сообщения коммита: ${LEN_MESSAGE_BODY}. Это превышает лимит в 100 символов)."
    echo "Пожалуйста, опиши свои изменения более компактно"
    exit 1
fi

# Все проверки прошли, сообщение коммита валидное
exit 0
