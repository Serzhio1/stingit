#!/bin/bash
# ============================================================
#                   Git Commit Message Hook
# ------------------------------------------------------------
# Скрипт для проверки формата сообщения коммита
#
# Требования к сообщению коммита:
#  1. В начале обязательно один из типов:
#       fix:, refactor:, test:, docs:
#  2. Далее через пробел ссылка на задачу в JIRA в формате:
#       [OSG-123], [OSG-12], [OSG-1234] и т.п.
#  3. После этого через пробел должно идти содержательное сообщение,
#       не являющееся слишком общим/мусорным (например, "fix bug", "do smth" и т.п.)
#
# Примеры правильных сообщений:
#  - fix: [OSG-123] исправлен баг с авторизацией
#  - docs: [OSG-12] обновлена документация по API
#  - refactor: [OSG-134] переработан модуль логирования
#  - test: [OSG-56] добавлены тесты для нового функционала
#
# Примеры сообщений, которые вызовут ошибку:
#  - fix bug
#  - do smth
#  - test: [OSG-123] 
#  - update [OSG-12] minor changes
#
# Важно:
#  - Этот скрипт выполняется на этапе "commit", после того как сообщение коммита сформировано
#  - Скрипт должен называться ровно: "commit-msg", и никак иначе
#  - Скрипт должен находиться в каталоге: ".git/hooks/", и нигде иначе 
#  - Файл должен быть исполняемым (chmod +x)
#
# ============================================================

MSG_FILE=$1
COMMIT_MSG=$(cat "$MSG_FILE")
COMMIT_MSG=$(echo "$COMMIT_MSG" | tr -d '\r')  # CRLF -> LF

# ---------- 1. Проверка типа коммита ----------
ALLOWED_TYPES="fix|refactor|test|docs"

if ! [[ $COMMIT_MSG =~ ^($ALLOWED_TYPES): ]]; then
    echo "Ошибка: сообщение коммита должно начинаться с одного из типов: fix:, refactor:, test:, docs:"
    exit 1
fi

# ---------- 2. Проверка JIRA-таски ----------
if ! [[ $COMMIT_MSG =~ ^($ALLOWED_TYPES):\ \[OSG-[0-9]+\] ]]; then
    echo "Ошибка: после типа коммита должна идти ссылка на задачу в формате [OSG-123]"
    exit 1
fi

# ---------- 3. Проверка содержательности сообщения ----------
MESSAGE_BODY=$(echo "$COMMIT_MSG" | sed -E "s/^($ALLOWED_TYPES):\ \[OSG-[0-9]+\]//")
BAD_MESSAGES=("fix bug" "do smth" "test" "update" "temp" "misc")

for bad in "${BAD_MESSAGES[@]}"; do
    if [[ "${MESSAGE_BODY,,}" == "$bad" ]]; then
        echo "Ошибка: сообщение коммита слишком общое/неинформативное: \"$MESSAGE_BODY\""
        exit 1
    fi
done

# Все проверки прошли, сообщение коммита валидное
exit 0
