#!/usr/bin/env bash
set -euo pipefail
# ============================================================
#                   Git Commit Message Hook
# ------------------------------------------------------------
# Скрипт для проверки формата сообщения коммита
#
# Требования к сообщению коммита:
#  1. В начале обязательно один из типов:
#       fix:, refactor:, test:
#  2. Далее через один пробел ссылка на задачу в формате:
#       [KSC-123], [OSG-12], [ESB-1234] и т.п.
#  3. После этого через один пробел должно идти содержательное описание изменений.
#     Для этого пункта проводится проверка на:
#      - минимальное количество слов в описании изменений
#      - минимальное количество символов в описании изменений
#      - максимальную длину всего сообщения коммита 
# Многие параметры данного хука можно настраивать под себя с помощью переменных, находящихся ниже
#
# Примеры валидных сообщений:
#  - fix: [GE-123] исправлен баг с авторизацией в методе 'authUser'
#  - fix: [DIS-012] Обновлена документация по API для метода 'changeCarColour' до версии "1.2.6"
#  - refactor: [AAPL-1] проведен рефакторинг класса «UserRequiredDocs» для уменьшения кол-ва методов в одном классе
#  - test: [NKE-565681] Добавлены тесты для нового функционала для расчета площади произвольного многоугольника 
#
# Примеры плохих сообщений, которые не пройдут валидацию и вызовут ошибку:
#  - refactor some methods
#  - исправлены некоторые зависимости
#  - test: [SBUX-123]
#  - fix: [BA-12] fix some bugs
#
# Важно:
#  - этот скрипт выполняется на этапе "commit", после того как сообщение коммита сформировано
#  - скрипт должен находиться в каталоге ".git/hooks/", и нигде иначе
#  - скрипт должен называться "commit-msg", и никак иначе
#  - файл со скриптом должен быть исполняемым (chmod +x)
#
# ============================================================


# Переменные, в которых не стоит менять значения
COMMIT_MESSAGE_FILE="$1"
ROW_COMMIT_MESSAGE=$(<"$COMMIT_MESSAGE_FILE")
COMMIT_MESSAGE=$(echo "$ROW_COMMIT_MESSAGE" | tr -d '\r')  # CRLF -> LF

# Переменные, в которых без проблем можно поменять значения под себя
ALLOWED_COMMIT_TYPES="fix:|refactor:|test:"
PREFIX_TASK_NAME="OSG"
MAX_LEN_COMMIT_MESSAGE=250
MIN_COUNT_WORDS_IN_DESCRIPTION_CHANGES=5
MIN_COUNT_CHARS_IN_DESCRIPTION_CHANGES=30
EXAMPLE_GOOD_COMMIT_MESSAGE="Пример хорошего коммита «fix: [${PREFIX_TASK_NAME}-1194] написал  метод 'calcDevSalary()', который увеличивает зарплату программистам вдвое»"


# ---------- 1. Проверка на наличие разрешенного типа коммита ----------
if ! [[ "${COMMIT_MESSAGE}" =~ ^(${ALLOWED_COMMIT_TYPES}) ]]; then
    echo "Ошибка: сообщение коммита должно начинаться с одного из следующих типов с двоеточием: ${ALLOWED_COMMIT_TYPES}"
    echo "${EXAMPLE_GOOD_COMMIT_MESSAGE}"
    exit 1
fi

# ---------- 2. Проверка на наличие задачи и описания изменений ----------
if [[ "${COMMIT_MESSAGE}" =~ ^(${ALLOWED_COMMIT_TYPES})[[:space:]]*$ ]]; then
    echo "Ошибка: помимо типа коммита, в сообщении обязательно должны присутствовать задача и описание изменений"
    echo "${EXAMPLE_GOOD_COMMIT_MESSAGE}"
    exit 1
fi

# ---------- 3. Проверка на наличие пробела и отсутствие лишних символов перед задачей ----------
if ! [[ "${COMMIT_MESSAGE}" =~ ^(${ALLOWED_COMMIT_TYPES})[[:space:]] ]]; then
    echo "Ошибка: перед задачей должен находиться один пробел и никаких лишних символов"
    echo "${EXAMPLE_GOOD_COMMIT_MESSAGE}"
    exit 1
fi

# ---------- 3.1. Проверка на наличие единственного пробела перед задачей ----------
if [[ "${COMMIT_MESSAGE}" =~ ^(${ALLOWED_COMMIT_TYPES})[[:space:]]{2,} ]]; then
    echo "Ошибка: перед задачей должен находиться только один пробел"
    echo "${EXAMPLE_GOOD_COMMIT_MESSAGE}"
    exit 1
fi

# ---------- 4. Проверка на наличие задачи после типа коммита ----------
if ! [[ "${COMMIT_MESSAGE}" =~ ^(${ALLOWED_COMMIT_TYPES})[[:space:]]\[${PREFIX_TASK_NAME}-[0-9]+\] ]]; then
    echo "Ошибка: после типа коммита ожидается задача в формате [${PREFIX_TASK_NAME}-123]"
    echo "${EXAMPLE_GOOD_COMMIT_MESSAGE}"
    exit 1
fi

#----------- 5. Проверка на наличие описания изменений ----------
if [[ "${COMMIT_MESSAGE}" =~ ^(${ALLOWED_COMMIT_TYPES})[[:space:]]\[${PREFIX_TASK_NAME}-[0-9]+\][[:space:]]*$ ]]; then
    echo "Ошибка: помимо типа коммита и задачи, в сообщении обязательно должно присутствовать описание изменений"
    echo "${EXAMPLE_GOOD_COMMIT_MESSAGE}"
    exit 1
fi

# ---------- 6. Проверка на наличие пробела и отсутствие лишних символов после задачи ----------
if ! [[ "${COMMIT_MESSAGE}" =~ ^(${ALLOWED_COMMIT_TYPES})[[:space:]]\[${PREFIX_TASK_NAME}-[0-9]+\][[:space:]] ]]; then
    echo "Ошибка: после задачи должен находится один пробел и никаких лишних символов"
    echo "${EXAMPLE_GOOD_COMMIT_MESSAGE}"
    exit 1
fi

# ---------- 6.1 Проверка на наличие единственного пробела после задачи ----------
if [[ "${COMMIT_MESSAGE}" =~ ^(${ALLOWED_COMMIT_TYPES})[[:space:]]\[${PREFIX_TASK_NAME}-[0-9]+\][[:space:]]{2,} ]]; then
    echo "Ошибка: после задачи должен находится только один пробел"
    echo "${EXAMPLE_GOOD_COMMIT_MESSAGE}"
    exit 1
fi

# ---------- Получаем кол-во слов и символов в описании изменений ----------
DESCRIPTION_CHANGES=$(echo "${COMMIT_MESSAGE}" | sed -E "s/^(${ALLOWED_COMMIT_TYPES})[[:space:]]\[${PREFIX_TASK_NAME}-[0-9]+\][[:space:]]//")
COUNT_WORDS_IN_DESCRIPTION_CHANGES=$(echo "${DESCRIPTION_CHANGES}" | wc -w)
COUNT_CHARS_IN_DESCRIPTION_CHANGES=$(echo -n "${DESCRIPTION_CHANGES}" | wc -m)

# ---------- 7. Проверка на минимальное количество слов в описании изменений ----------
if (( COUNT_WORDS_IN_DESCRIPTION_CHANGES < MIN_COUNT_WORDS_IN_DESCRIPTION_CHANGES )); then
    echo "Ошибка: описание изменений должно состоять более, чем из ${MIN_COUNT_WORDS_IN_DESCRIPTION_CHANGES} слов"
    echo "${EXAMPLE_GOOD_COMMIT_MESSAGE}"
    exit 1
fi

# ---------- 8. Проверка на минимальное количество символов в описании изменений ----------
if (( COUNT_CHARS_IN_DESCRIPTION_CHANGES < MIN_COUNT_CHARS_IN_DESCRIPTION_CHANGES )); then
    echo "Ошибка: описание изменений должно состоять более, чем из ${MIN_COUNT_CHARS_IN_DESCRIPTION_CHANGES} символов. Сейчас - ${COUNT_CHARS_IN_DESCRIPTION_CHANGES}"
    echo "${EXAMPLE_GOOD_COMMIT_MESSAGE}"
    exit 1
fi

# ---------- 9. Проверка на максимальное количество символов в сообщении коммита ----------
LEN_COMMIT_MESSAGE=${#COMMIT_MESSAGE}
if (( LEN_COMMIT_MESSAGE > MAX_LEN_COMMIT_MESSAGE )); then
    echo "Ошибка: текущая длина сообщения коммита: ${LEN_COMMIT_MESSAGE}. Это превышает лимит в ${MAX_LEN_COMMIT_MESSAGE} символов"
    echo "Пожалуйста, опиши свои изменения более компактно"
    exit 1
fi

# Все проверки прошли, сообщение коммита валидное
exit 0
